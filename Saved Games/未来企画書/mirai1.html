<!DOCTYPE html>
<html lang="ja">
<head>
    <meta charset="UTF-8" />ã€€
    <meta name="viewport" content="width=device-width, initial-scale=1.0, viewport-fit=cover">
    <title>AIéŸ³å£°å…¥åŠ›ã‚¢ã‚·ã‚¹ã‚¿ãƒ³ãƒˆUI (ãƒ†ã‚­ã‚¹ãƒˆ/ãƒã‚¤ã‚¯å¯¾å¿œ)</title>
    <style>
        /* CSSã¯å¤‰æ›´ãªã— */
        body {
            margin: 0;
            background: #0f0f0f;
            font-family: 'Segoe UI', sans-serif;
            overflow: hidden;
            color: #fff;
        }

        #waveCanvas {
            position: fixed;
            top: 0; 
            left: 0;
            width: 100vw;
            height: 100vh;
            z-index: 0;
        }

        /* UIã‚³ãƒ³ãƒ†ãƒŠï¼ˆã‚¹ãƒãƒ›ç¸¦æ¨ªå¯¾å¿œï¼‰ */
        #ui {
            position: absolute;
            bottom: calc(4% + env(safe-area-inset-bottom));
            left: 50%;
            transform: translateX(-50%);
            width: 90%;
            max-width: 600px;
            z-index: 10;
            display: flex;
            flex-direction: column;
            gap: 10px;
        }

        /* ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸è¡¨ç¤ºã‚¨ãƒªã‚¢ */
        #chat-log {
            max-height: 40vh;
            overflow-y: auto;
            display: flex;
            flex-direction: column;
            gap: 10px;
            padding: 10px;
            background: rgba(0, 0, 0, 0.4);
            border-radius: 12px;
            backdrop-filter: blur(5px);
            margin-bottom: 10px;
        }

        .chat-message {
            padding: 8px 12px;
            border-radius: 10px;
            max-width: 80%;
            line-height: 1.4;
        }

        .user-message {
            align-self: flex-end;
            background-color: #007bff;
            color: white;
            border-bottom-right-radius: 2px;
        }

        .ai-message {
            align-self: flex-start;
            background-color: #2c2c2c;
            color: white;
            border-bottom-left-radius: 2px;
        }

        /* å…¥åŠ›ã‚¨ãƒªã‚¢ */
        #input-area {
            display: flex;
            gap: 10px;
            align-items: center;
        }

        #voice-input {
            flex-grow: 1;
            padding: 12px;
            border-radius: 25px;
            border: none;
            background: #333;
            color: white;
            font-size: 16px;
            outline: none;
        }
        #voice-input::placeholder {
            color: #aaa;
        }

        /* ãƒœã‚¿ãƒ³å…±é€š */
        .control-btn {
            width: 50px;
            height: 50px;
            border-radius: 50%;
            border: none;
            cursor: pointer;
            display: flex;
            align-items: center;
            justify-content: center;
            transition: all 0.2s;
            box-shadow: 0 4px 6px rgba(0, 0, 0, 0.3);
            flex-shrink: 0; /* ç¸®å°é˜²æ­¢ */
        }
        .control-btn:active {
            box-shadow: 0 2px 3px rgba(0, 0, 0, 0.5);
            transform: translateY(1px);
        }

        /* ãƒã‚¤ã‚¯/é€ä¿¡ãƒœã‚¿ãƒ³ */
        #send-btn {
            background-color: #1a73e8;
            color: white;
            font-size: 24px;
        }
        #send-btn.listening {
            background-color: #d93025; /* èµ¤è‰²ã§éŒ²éŸ³ä¸­ */
        }
        #send-btn:disabled {
            background-color: #555;
            cursor: not-allowed;
        }
        
        /* ãƒ­ã‚°ãƒœã‚¿ãƒ³ */
        #log-btn {
            background-color: #28a745; /* ç·‘è‰² */
            color: white;
            font-size: 14px;
            padding: 0 10px;
            width: auto;
            border-radius: 25px;
            height: 50px;
            line-height: 50px;
            font-weight: bold;
        }

        /* ã‚¹ãƒ†ãƒ¼ã‚¿ã‚¹è¡¨ç¤º */
        #status {
            position: absolute;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            color: #ddd;
            font-size: 1.5em;
            background: rgba(0, 0, 0, 0.5);
            padding: 10px 20px;
            border-radius: 15px;
            transition: opacity 0.5s;
            pointer-events: none;
            white-space: nowrap;
        }

        /* ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸ãƒœãƒƒã‚¯ã‚¹ */
        #message-box {
            position: fixed;
            top: 20px;
            left: 50%;
            transform: translateX(-50%);
            background-color: #333;
            color: white;
            padding: 15px 30px;
            border-radius: 8px;
            box-shadow: 0 4px 12px rgba(0, 0, 0, 0.2);
            z-index: 1000;
            opacity: 0;
            transition: opacity 0.3s ease-in-out;
            pointer-events: none;
            text-align: center;
        }
        #message-box.visible {
            opacity: 1;
        }
    </style>
</head>
<body>
    <canvas id="waveCanvas"></canvas>
    <div id="status">ã‚¹ã‚¿ãƒ³ãƒã‚¤ä¸­</div>
    <div id="chat-log"></div>
    <div id="ui">
        <!-- ãƒ­ã‚°é€ä¿¡ãƒœã‚¿ãƒ³ -->
        <div id="log-controls" style="display: flex; justify-content: flex-end; gap: 10px;">
            <button id="log-btn" class="control-btn">ãƒ­ã‚°ã‚’é€ä¿¡ï¼ˆè‡ªå‹•è¨˜éŒ²ä¸­ï¼‰</button>
        </div>

        <div id="input-area">
            <input type="text" id="voice-input" placeholder="ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸ã‚’å…¥åŠ›ã™ã‚‹ã‹ã€ãƒã‚¤ã‚¯ãƒœã‚¿ãƒ³ã‚’æŠ¼ã—ã¦ãã ã•ã„" />
            <button id="send-btn" class="control-btn">
                <span id="send-icon">ğŸ¤</span>
            </button>
        </div>
    </div>
    <div id="message-box"></div>

    <script>
        // // --- è¨­å®šã¨ã‚°ãƒ­ãƒ¼ãƒãƒ«å¤‰æ•° ---
        // const LLM_API_URL = "/llm/generate";
        // const LOG_API_URL = "/log_conversation";
        // const LLM_API_URL = "https://atjmuwnwmtjw-nose.hf.space/llm/generate";       
        // const LLM_API_URL = "https://atjmuwnwmtjw-nose.hf.space/llm/log_conversation;
        // const MQTT_API_URL = "https://atjmuwnwmtjw-nose.hf.space/iot/control"; 
ã€€ã€€
        // --- è¨­å®šã¨ã‚°ãƒ­ãƒ¼ãƒãƒ«å¤‰æ•° ---
        // LLMå¿œç­”ç”ŸæˆAPI (ä»¥å‰ã®LLM_API_URLã«å¯¾å¿œ)
        const LLM_API_URL = "https://atjmuwnwmtjw-nose.hf.space/llm/generate";
        
        // ä¼šè©±ãƒ­ã‚°é€ä¿¡API (ä»¥å‰ã®LOG_API_URLã«å¯¾å¿œ)
        const LOG_API_URL = "https://atjmuwnwmtjw-nose.hf.space/llm/log_conversation";
        
        // IoTåˆ¶å¾¡API
        const MQTT_API_URL = "https://atjmuwnwmtjw-nose.hf.space/iot/control";
        // â˜… è‡ªå‹•é€ä¿¡å…ˆãƒ¡ãƒ¼ãƒ«ã‚¢ãƒ‰ãƒ¬ã‚¹ â˜…
        const TARGET_EMAIL = "imakugijikirokusyu@gmail.com";

        let recognition = null;
        let isListening = false;
        let isSpeaking = false;
        const synth = window.speechSynthesis;
        const chatLog = document.getElementById('chat-log');
        const voiceInput = document.getElementById('voice-input');
        const sendBtn = document.getElementById('send-btn');
        const logBtn = document.getElementById('log-btn'); 
        const sendIcon = document.getElementById('send-icon');
        const statusBox = document.getElementById('status');
        const messageBox = document.getElementById('message-box');

        // ä¼šè©±å±¥æ­´ã‚’ä¿æŒã™ã‚‹é…åˆ—
        let chatHistory = []; 

        // --- UIãƒ˜ãƒ«ãƒ‘ãƒ¼é–¢æ•° ---
        function setStatus(message, isListeningStatus = false) {
            statusBox.textContent = message;
            statusBox.style.opacity = '1';
            sendBtn.classList.toggle('listening', isListeningStatus);
            sendIcon.textContent = isListeningStatus ? 'ğŸ”´' : 'ğŸ¤';
        }

        function setStandbyStatus() {
            setTimeout(() => {
                if (!isListening && !isSpeaking) {
                    setStatus('ã‚¹ã‚¿ãƒ³ãƒã‚¤ä¸­', false);
                }
            }, 100);
        }

        function showMessageBox(message) {
            messageBox.textContent = message;
            messageBox.classList.add('visible');
            setTimeout(() => {
                messageBox.classList.remove('visible');
            }, 5000);
        }

        function appendMessage(role, content) {
            const messageElement = document.createElement('div');
            messageElement.classList.add('chat-message', `${role}-message`);
            messageElement.textContent = content;
            chatLog.appendChild(messageElement);
            chatLog.scrollTop = chatLog.scrollHeight;
        }

        // å±¥æ­´ã‚’è¨˜éŒ²ã™ã‚‹é–¢æ•°
        function recordMessage(role, content) {
            chatHistory.push({
                role: role,
                content: content,
                timestamp: Date.now() / 1000 // ç§’å˜ä½ã®Unixã‚¿ã‚¤ãƒ ã‚¹ã‚¿ãƒ³ãƒ—
            });
        }

        // â˜… æ–°è¦è¿½åŠ : LLMå¿œç­”å¾Œã«è‡ªå‹•ã§ãƒ­ã‚°ã‚’é€ä¿¡ã™ã‚‹é–¢æ•° â˜…
        async function sendLogPerTurn() {
            // chatHistoryã®å…¨å±¥æ­´ã‚’æŒ‡å®šãƒ¡ãƒ¼ãƒ«ã‚¢ãƒ‰ãƒ¬ã‚¹å®›ã«è‡ªå‹•é€ä¿¡ï¼ˆã‚·ãƒŸãƒ¥ãƒ¬ãƒ¼ã‚·ãƒ§ãƒ³ï¼‰
            setStatus('ğŸ“§ ãƒ­ã‚°ã‚’è‡ªå‹•é€ä¿¡ä¸­...');
            
            try {
                const response = await fetch(LOG_API_URL, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                    },
                    body: JSON.stringify({ 
                        history: chatHistory, 
                        target_email: TARGET_EMAIL 
                    })
                });

                // if (!response.ok) {
                //     const errorDetail = (await response.json()).detail || response.statusText;
                //     throw new Error(`API Error ${response.status}: ${errorDetail}`);
                // }
                // sendLLMRequest é–¢æ•°å†…
                // ...
                if (!response.ok) {
                    let errorDetail = response.statusText;
                    
                    // ã‚µãƒ¼ãƒãƒ¼ãŒJSONã‚’è¿”ã™å¯èƒ½æ€§ãŒã‚ã‚‹ã‹è©¦ã™
                    try {
                        const errorData = await response.json();
                        // 'detail' ãƒ•ã‚£ãƒ¼ãƒ«ãƒ‰ãŒã‚ã‚‹ã‹ç¢ºèªã™ã‚‹ãªã©
                        errorDetail = errorData.detail || JSON.stringify(errorData);
                    } catch (e) {
                        // JSONè§£æã«å¤±æ•—ã—ãŸå ´åˆï¼ˆHTMLãŒè¿”ã•ã‚ŒãŸå ´åˆãªã©ï¼‰ã¯ä½•ã‚‚ã—ãªã„
                        console.error("ã‚¨ãƒ©ãƒ¼ãƒ¬ã‚¹ãƒãƒ³ã‚¹ãŒJSONã§ã¯ã‚ã‚Šã¾ã›ã‚“ã§ã—ãŸ:", e);
                        // response.text() ã‚’ä½¿ã£ã¦HTMLå…¨ä½“ã‚’ãƒ­ã‚°ã«å‡ºåŠ›ã—ã¦ã‚‚è‰¯ã„
                    }
                    
                    throw new Error(`API Error ${response.status} (${response.statusText}): ${errorDetail}`);
                }
                
                // ...

                const data = await response.json();
                
                // è‡ªå‹•é€ä¿¡ã®æˆåŠŸã¯ã‚³ãƒ³ã‚½ãƒ¼ãƒ«ã«ã®ã¿è¨˜éŒ²
                console.log(`âœ… è‡ªå‹•ãƒ­ã‚°é€ä¿¡æˆåŠŸã€‚ã‚¿ãƒ¼ã‚²ãƒƒãƒˆ: ${TARGET_EMAIL}ã€‚ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸: ${data.message}`);
                
            } catch (error) {
                console.error("è‡ªå‹•ãƒ­ã‚°é€ä¿¡ãƒªã‚¯ã‚¨ã‚¹ãƒˆã‚¨ãƒ©ãƒ¼:", error);
                // ãƒ¦ãƒ¼ã‚¶ãƒ¼ã«ã¯ç›®ç«‹ãŸãªã„ã‚ˆã†ã«ã™ã‚‹
            } finally {
                // setStandbyStatus() ã¯ sendLLMRequest ã® finally ã§å‘¼ã°ã‚Œã‚‹
            }
        }

        // --- LLM (Gemini) å‡¦ç† ---

        async function sendLLMRequest(prompt) {
            if (!prompt.trim()) return;

            // ãƒ¦ãƒ¼ã‚¶ãƒ¼ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸ã‚’UIã«è¿½åŠ 
            appendMessage('user', prompt);
            // å±¥æ­´ã«è¨˜éŒ²
            recordMessage('user', prompt);
            
            setStatus('ğŸ¤– å¿œç­”ã‚’ç”Ÿæˆä¸­...');
            voiceInput.value = '';
            
            try {
                const response = await fetch(LLM_API_URL, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                        // Basicèªè¨¼ã¯ãƒ–ãƒ©ã‚¦ã‚¶ãŒè‡ªå‹•ã§å‡¦ç†ã™ã‚‹ãŸã‚ã€ã“ã“ã§ã¯Credentialsã¯ä¸è¦
                    },
                    body: JSON.stringify({ prompt: prompt, max_length: 1000 })
                });

                // if (!response.ok) {
                //     const errorDetail = (await response.json()).detail || response.statusText;
                //     throw new Error(`API Error ${response.status}: ${errorDetail}`);
                // }
                // sendLLMRequest é–¢æ•°å†…
                // ...
                if (!response.ok) {
                    let errorDetail = response.statusText;
                    
                    // ã‚µãƒ¼ãƒãƒ¼ãŒJSONã‚’è¿”ã™å¯èƒ½æ€§ãŒã‚ã‚‹ã‹è©¦ã™
                    try {
                        const errorData = await response.json();
                        // 'detail' ãƒ•ã‚£ãƒ¼ãƒ«ãƒ‰ãŒã‚ã‚‹ã‹ç¢ºèªã™ã‚‹ãªã©
                        errorDetail = errorData.detail || JSON.stringify(errorData);
                    } catch (e) {
                        // JSONè§£æã«å¤±æ•—ã—ãŸå ´åˆï¼ˆHTMLãŒè¿”ã•ã‚ŒãŸå ´åˆãªã©ï¼‰ã¯ä½•ã‚‚ã—ãªã„
                        console.error("ã‚¨ãƒ©ãƒ¼ãƒ¬ã‚¹ãƒãƒ³ã‚¹ãŒJSONã§ã¯ã‚ã‚Šã¾ã›ã‚“ã§ã—ãŸ:", e);
                        // response.text() ã‚’ä½¿ã£ã¦HTMLå…¨ä½“ã‚’ãƒ­ã‚°ã«å‡ºåŠ›ã—ã¦ã‚‚è‰¯ã„
                    }
                    
                    throw new Error(`API Error ${response.status} (${response.statusText}): ${errorDetail}`);
                }
                // ...

                const data = await response.json();
                const aiResponse = data.text;

                // AIãƒ¡ãƒƒã‚»ãƒ¼ã‚¸ã‚’UIã«è¿½åŠ 
                appendMessage('ai', aiResponse);
                // å±¥æ­´ã«è¨˜éŒ²
                recordMessage('ai', aiResponse);
                
                speak(aiResponse);
                
                // â˜… è‡ªå‹•ãƒ­ã‚°é€ä¿¡ã‚’å‘¼ã³å‡ºã™ â˜…
                await sendLogPerTurn();

            } catch (error) {
                console.error("LLMãƒªã‚¯ã‚¨ã‚¹ãƒˆã‚¨ãƒ©ãƒ¼:", error);
                const errorMessage = `ã‚¨ãƒ©ãƒ¼ãŒç™ºç”Ÿã—ã¾ã—ãŸ: ${error.message}`;
                appendMessage('ai', errorMessage);
                recordMessage('ai', errorMessage);
                speak("ã‚·ã‚¹ãƒ†ãƒ ã‚¨ãƒ©ãƒ¼ãŒç™ºç”Ÿã—ã¾ã—ãŸã€‚ã‚³ãƒ³ã‚½ãƒ¼ãƒ«ã‚’ç¢ºèªã—ã¦ãã ã•ã„ã€‚");
            } finally {
                setStandbyStatus();
            }
        }

        // --- éŸ³å£°åˆæˆ (TTS) ---

        function speak(text) {
            if (synth.speaking) {
                synth.cancel();
            }
            
            isSpeaking = true;
            setStatus('ğŸ”Š ç™ºè©±ä¸­...');
            
            const utterance = new SpeechSynthesisUtterance(text);
            utterance.lang = 'ja-JP';
            
            // æ—¥æœ¬èªã§è½ã¡ç€ã„ãŸå£°ã‚’æ¢ã™
            const preferredVoice = synth.getVoices().find(v => v.lang === 'ja-JP' && v.name.includes('Kyoko'));
            if (preferredVoice) {
                utterance.voice = preferredVoice;
            }

            utterance.onend = () => {
                isSpeaking = false;
                setStandbyStatus();
            };
            utterance.onerror = (event) => {
                console.error('SpeechSynthesisUtterance.onerror', event);
                isSpeaking = false;
                setStandbyStatus();
            };

            synth.speak(utterance);
        }

        // --- éŸ³å£°èªè­˜ (STT) ---

        function startRecognition() {
            if (!('webkitSpeechRecognition' in window)) {
                showMessageBox("ãŠä½¿ã„ã®ãƒ–ãƒ©ã‚¦ã‚¶ã¯éŸ³å£°èªè­˜ã«å¯¾å¿œã—ã¦ã„ã¾ã›ã‚“ã€‚ãƒ†ã‚­ã‚¹ãƒˆå…¥åŠ›ã‚’ã”åˆ©ç”¨ãã ã•ã„ã€‚");
                return;
            }

            if (recognition) {
                recognition.stop();
                recognition = null;
            }

            recognition = new webkitSpeechRecognition();
            recognition.lang = 'ja-JP';
            recognition.interimResults = false;
            recognition.maxAlternatives = 1;

            recognition.onstart = () => {
                isListening = true;
                setStatus('ğŸ‘‚ ãƒªã‚¹ãƒ‹ãƒ³ã‚°ä¸­...', true);
            };

            recognition.onresult = (event) => {
                const transcript = event.results[0][0].transcript;
                voiceInput.value = transcript;
                recognition.stop();
                sendLLMRequest(transcript); // èªè­˜çµæœã‚’LLMã«é€ä¿¡
            };

            recognition.onerror = (event) => {
                console.error('Recognition error:', event.error);
                if (event.error !== 'no-speech') {
                    showMessageBox(`éŸ³å£°èªè­˜ã‚¨ãƒ©ãƒ¼: ${event.error}`);
                }
                isListening = false;
                setStandbyStatus();
            };

            recognition.onend = () => {
                isListening = false;
                setStandbyStatus();
            };

            recognition.start();
        }

        // --- ã‚¤ãƒ™ãƒ³ãƒˆãƒªã‚¹ãƒŠãƒ¼ ---

        // ãƒã‚¤ã‚¯/é€ä¿¡ãƒœã‚¿ãƒ³ã®ã‚¯ãƒªãƒƒã‚¯ã‚¤ãƒ™ãƒ³ãƒˆ
        sendBtn.addEventListener("click", () => {
            if (isListening) {
                // éŒ²éŸ³ä¸­ã«å†åº¦æŠ¼ã•ã‚ŒãŸå ´åˆã¯åœæ­¢
                recognition.stop();
            } else if (voiceInput.value.trim() !== "") {
                // ãƒ†ã‚­ã‚¹ãƒˆå…¥åŠ›ãŒã‚ã‚‹å ´åˆã¯é€ä¿¡
                sendLLMRequest(voiceInput.value);
            } else {
                // ãƒ†ã‚­ã‚¹ãƒˆå…¥åŠ›ãŒãªãã€éŒ²éŸ³ä¸­ã§ãªã„å ´åˆã¯éŒ²éŸ³é–‹å§‹
                startRecognition();
            }
        });

        // Enterã‚­ãƒ¼ã§ã®é€ä¿¡
        voiceInput.addEventListener("keypress", (e) => {
            if (e.key === "Enter" && voiceInput.value.trim() !== "") {
                sendLLMRequest(voiceInput.value);
            }
        });

        // ãƒ­ã‚°é€ä¿¡ãƒœã‚¿ãƒ³ã®ã‚¯ãƒªãƒƒã‚¯ã‚¤ãƒ™ãƒ³ãƒˆ (æ‰‹å‹•é€ä¿¡ç¢ºèªç”¨)
        logBtn.addEventListener("click", async () => {
            if (chatHistory.length === 0) {
                showMessageBox("ä¼šè©±å±¥æ­´ãŒã‚ã‚Šã¾ã›ã‚“ã€‚");
                return;
            }

            setStatus('ğŸ“§ ãƒ­ã‚°ã‚’æ‰‹å‹•ã§ç¢ºèªä¸­...');
            
            try {
                const response = await fetch(LOG_API_URL, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                    },
                    body: JSON.stringify({ 
                        history: chatHistory, 
                        target_email: TARGET_EMAIL 
                    })
                });

                // if (!response.ok) {
                //     const errorDetail = (await response.json()).detail || response.statusText;
                //     throw new Error(`API Error ${response.status}: ${errorDetail}`);
                // }

                // sendLLMRequest é–¢æ•°å†…
                // ...
                if (!response.ok) {
                    let errorDetail = response.statusText;
                    
                    // ã‚µãƒ¼ãƒãƒ¼ãŒJSONã‚’è¿”ã™å¯èƒ½æ€§ãŒã‚ã‚‹ã‹è©¦ã™
                    try {
                        const errorData = await response.json();
                        // 'detail' ãƒ•ã‚£ãƒ¼ãƒ«ãƒ‰ãŒã‚ã‚‹ã‹ç¢ºèªã™ã‚‹ãªã©
                        errorDetail = errorData.detail || JSON.stringify(errorData);
                    } catch (e) {
                        // JSONè§£æã«å¤±æ•—ã—ãŸå ´åˆï¼ˆHTMLãŒè¿”ã•ã‚ŒãŸå ´åˆãªã©ï¼‰ã¯ä½•ã‚‚ã—ãªã„
                        console.error("ã‚¨ãƒ©ãƒ¼ãƒ¬ã‚¹ãƒãƒ³ã‚¹ãŒJSONã§ã¯ã‚ã‚Šã¾ã›ã‚“ã§ã—ãŸ:", e);
                        // response.text() ã‚’ä½¿ã£ã¦HTMLå…¨ä½“ã‚’ãƒ­ã‚°ã«å‡ºåŠ›ã—ã¦ã‚‚è‰¯ã„
                    }
                    
                    throw new Error(`API Error ${response.status} (${response.statusText}): ${errorDetail}`);
                }
                // ...

                const data = await response.json();
                
                // æ‰‹å‹•é€ä¿¡ã®ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸ã‚’ãƒ¦ãƒ¼ã‚¶ãƒ¼ã«è¡¨ç¤º
                showMessageBox(`æ‰‹å‹•ãƒ­ã‚°é€ä¿¡ã‚·ãƒŸãƒ¥ãƒ¬ãƒ¼ã‚·ãƒ§ãƒ³å®Œäº†ã€‚ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸: ${data.message}`);
                
                // ãƒ­ã‚°å†…å®¹ã‚’ã‚³ãƒ³ã‚½ãƒ¼ãƒ«ã«ã‚‚è¡¨ç¤ºï¼ˆç¢ºèªç”¨ï¼‰
                console.log("--- æ‰‹å‹•ãƒ­ã‚°ãƒ•ã‚¡ã‚¤ãƒ«å‡ºåŠ›å†…å®¹ ---");
                console.log(data.log_content);

            } catch (error) {
                console.error("æ‰‹å‹•ãƒ­ã‚°é€ä¿¡ãƒªã‚¯ã‚¨ã‚¹ãƒˆã‚¨ãƒ©ãƒ¼:", error);
                showMessageBox(`ãƒ­ã‚°é€ä¿¡ã‚¨ãƒ©ãƒ¼ãŒç™ºç”Ÿã—ã¾ã—ãŸ: ${error.message}`);
            } finally {
                setStandbyStatus();
            }
        });

        // ãƒšãƒ¼ã‚¸ãƒ­ãƒ¼ãƒ‰æ™‚ã®åˆæœŸåŒ–
        window.onload = () => {
            // TTSåˆæœŸåŒ–
            if (synth.getVoices().length === 0) {
                 // éŸ³å£°ãŒãƒ­ãƒ¼ãƒ‰ã•ã‚Œã‚‹ã¾ã§å¾…æ©Ÿ
                window.speechSynthesis.onvoiceschanged = () => {
                    setStandbyStatus();
                };
            } else {
                setStandbyStatus();
            }
        };

        // --- æ³¢å½¢ã‚¢ãƒ‹ãƒ¡ãƒ¼ã‚·ãƒ§ãƒ³ (Canvas) ---
        const canvas = document.getElementById('waveCanvas');
        const ctx = canvas.getContext('2d');
        let animationFrameId;

        function resizeCanvas() {
            canvas.width = window.innerWidth;
            canvas.height = window.innerHeight;
        }
        window.addEventListener('resize', resizeCanvas);
        resizeCanvas();

        function drawWave() {
            ctx.clearRect(0, 0, canvas.width, canvas.height);
            
            if (isListening || isSpeaking) {
                const centerX = canvas.width / 2;
                const centerY = canvas.height / 2;
                // ã‚ˆã‚Šãƒªãƒƒãƒãªæ³¢å½¢ã‚¢ãƒ‹ãƒ¡ãƒ¼ã‚·ãƒ§ãƒ³ (çœç•¥)
                const time = Date.now() * 0.005;
                const waveCount = 3;
                
                for(let i = 0; i < waveCount; i++) {
                    const baseRadius = 50 + i * 20;
                    const radius = baseRadius + Math.sin(time + i * 1.5) * 15;
                    
                    ctx.beginPath();
                    ctx.arc(centerX, centerY, radius, 0, Math.PI * 2);
                    
                    let alpha = 0.3 - i * 0.1;
                    if (isListening) {
                        ctx.strokeStyle = `rgba(255, 255, 0, ${alpha})`; // ãƒªã‚¹ãƒ‹ãƒ³ã‚°ä¸­: é»„è‰²
                    } else {
                        ctx.strokeStyle = `rgba(0, 128, 255, ${alpha})`; // ç™ºè©±ä¸­: é’
                    }
                    ctx.lineWidth = 4;
                    ctx.stroke();
                }
            }

            animationFrameId = requestAnimationFrame(drawWave);
        }
        
        drawWave();

    </script>
</body>
</html>
