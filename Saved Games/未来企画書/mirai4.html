<!-- indexAI.html: AIéŸ³å£°ã‚¢ã‚·ã‚¹ã‚¿ãƒ³ãƒˆï¼ˆä¿®æ­£ç‰ˆï¼‰ -->
<!doctype html>
<html lang="ja">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width,initial-scale=1" />
<title>ã‚¤ãƒã‚¸ãƒ³ã•ã‚“ AI Voice Assistant (è‡ªå‹•é€£ç¶šèªè­˜ + VAD)</title>
<style>
/* CSSéƒ¨åˆ†ã¯å¤‰æ›´ãªã— */
    :root{--accent:#00ffff;--accent-2:#00ffaa;--bg:#0f0f0f}
    html,body{height:100%;margin:0;background:var(--bg);color:#fff;font-family:Segoe UI,system-ui,Arial}
    canvas{position:fixed;inset:0;z-index:0}
    
    /* ğŸ’¡ UIã®ãƒ•ã‚§ãƒ¼ãƒ‰ã‚¤ãƒ³/ã‚¢ã‚¦ãƒˆã¨ã‚¿ãƒƒãƒ—é ˜åŸŸã®ã‚¹ã‚¿ã‚¤ãƒ« */
    #ui{
        position:absolute;left:50%;bottom:5%;transform:translateX(-50%);z-index:10;width:min(980px,94vw);
        opacity: 1; /* åˆæœŸè¡¨ç¤º */
        transition: opacity 0.5s ease-in-out; /* ã‚¢ãƒ‹ãƒ¡ãƒ¼ã‚·ãƒ§ãƒ³è¨­å®š */
    }
    /* ç”»é¢å…¨ä½“ã‚’ã‚¿ãƒƒãƒ—é ˜åŸŸã¨ã—ã¦è¨­å®š */
    #tapArea {
        position: fixed;
        inset: 0;
        z-index: 5; /* UIã®ä¸‹ã€ã‚­ãƒ£ãƒ³ãƒã‚¹ã®ä¸Šã«é…ç½® */
    }

    #status-area{padding:14px 20px;border-radius:12px;text-align:center;font-weight:600;min-height:24px;background:#333;margin-bottom:20px;box-shadow:0 8px 16px rgba(0,0,0,.3)}
    #controls{display:flex;justify-content:center;gap:15px;margin-top:20px}
    button{background:var(--accent);color:#000;border:none;padding:12px 25px;border-radius:8px;font-weight:700;cursor:pointer;transition:background .2s, transform .1s;box-shadow:0 4px 6px rgba(0,0,0,.2)}
    button:active{transform:scale(0.98)}
    #transcript-box{background:#222;padding:15px;border-radius:12px;margin-top:20px;min-height:100px;font-size:1.1rem;line-height:1.6;box-shadow:0 4px 8px rgba(0,0,0,.2);white-space: pre-wrap;}
    #input-text{width:100%;padding:12px;box-sizing:border-box;border-radius:8px;border:1px solid #555;background:#333;color:#fff;font-size:1rem;margin-bottom:10px}
    .response-text{color:var(--accent-2);margin-top:10px;padding:10px;border-left:4px solid var(--accent-2)}
</style>
</head>
<body>

<canvas id="waveformCanvas"></canvas>
<div id="tapArea"></div>

<div id="ui">
    <div id="status-area">Ready</div>
    <textarea id="input-text" placeholder="ã“ã“ã«ãƒ†ã‚­ã‚¹ãƒˆã‚’å…¥åŠ›ã™ã‚‹ã‹ã€ãƒã‚¤ã‚¯ã§è©±ã—ã‹ã‘ã¦ãã ã•ã„..." rows="4"></textarea>
    <div id="controls">
        <button id="sendBtn">é€ä¿¡ (ãƒ†ã‚­ã‚¹ãƒˆ/éŸ³å£°)</button>
        <button id="resetBtn">ãƒªã‚»ãƒƒãƒˆ/å†éŒ²éŸ³</button>
        <button id="googleSearchToggle" class="bg-gray-500 hover:bg-gray-600">Googleæ¤œç´¢ OFF</button>
    </div>
    <div id="transcript-box"></div>
</div>

<script>
/* ----------------------------------------------------
    Web Audio / STT (Speech-to-Text) Setup
---------------------------------------------------- */
const canvas = document.getElementById('waveformCanvas');
const ctx = canvas.getContext('2d');
const input = document.getElementById('input-text');
const sendBtn = document.getElementById('sendBtn');
const resetBtn = document.getElementById('resetBtn');
const googleSearchToggle = document.getElementById('googleSearchToggle');
const transcriptBox = document.getElementById('transcript-box');
const tapArea = document.getElementById('tapArea');

const GEMINI_BACKEND_URL = "/gemini-generate"; // FastAPIã‚¨ãƒ³ãƒ‰ãƒã‚¤ãƒ³ãƒˆ

let audioContext;
let analyser;
let mediaStreamSource;
let recognition; // Web Speech Recognition
let isRecording = false; // éŒ²éŸ³/èªè­˜ä¸­ãƒ•ãƒ©ã‚°
let audioBufferQueue = []; // éŸ³å£°ãƒ‡ãƒ¼ã‚¿ã®ã‚­ãƒ¥ãƒ¼ (å°†æ¥çš„ãªVAD/Whisperç”¨)
let lastSpeechTime = Date.now(); // æœ€å¾Œã«ç™ºè¨€ãŒã‚ã£ãŸæ™‚é–“
const SILENCE_THRESHOLD_MS = 1000; // éŸ³å£°çµ‚äº†ã¨åˆ¤æ–­ã™ã‚‹ã¾ã§ã®æ™‚é–“
const synth = window.speechSynthesis; // TTSã‚¨ãƒ³ã‚¸ãƒ³
let isGoogleSearchEnabled = false; // Google Searchã®æœ‰åŠ¹/ç„¡åŠ¹

// HTMLã®ã‚µã‚¤ã‚ºã«åˆã‚ã›ã¦ã‚­ãƒ£ãƒ³ãƒã‚¹ã‚’ãƒªã‚µã‚¤ã‚º
function resizeCanvas() {
    canvas.width = window.innerWidth;
    canvas.height = window.innerHeight;
}
window.addEventListener('resize', resizeCanvas);
resizeCanvas();

// ã‚¹ãƒ†ãƒ¼ã‚¿ã‚¹è¡¨ç¤ºã®æ›´æ–°
function status(message) {
    document.getElementById('status-area').textContent = message;
}

// STTã¨ã‚ªãƒ¼ãƒ‡ã‚£ã‚ªã®åˆæœŸåŒ–
function initAudioAndSTT() {
    // æ—¢å­˜ã®èªè­˜ã‚’åœæ­¢
    if (recognition) {
        recognition.stop();
        recognition = null;
    }
    if (mediaStreamSource) {
        mediaStreamSource.mediaStream.getTracks().forEach(track => track.stop());
    }
    
    // Web Speech Recognitionã®åˆæœŸåŒ–
    if ('webkitSpeechRecognition' in window) {
        recognition = new webkitSpeechRecognition();
        // é€£ç¶šèªè­˜ã‚’æœ‰åŠ¹ã«ã™ã‚‹
        recognition.continuous = true;
        // æš«å®šçµæœã‚’è¿”ã™ã‚ˆã†ã«ã™ã‚‹ (VADã®ãƒ’ãƒ³ãƒˆã¨ã—ã¦åˆ©ç”¨)
        recognition.interimResults = true;
        recognition.lang = 'ja-JP';

        recognition.onstart = () => {
            isRecording = true;
            status('Listening... (è©±ã—ã‹ã‘ã¦ãã ã•ã„)');
        };

        recognition.onresult = (event) => {
            let interim_transcript = '';
            let final_transcript = '';

            for (let i = event.resultIndex; i < event.results.length; ++i) {
                if (event.results[i].isFinal) {
                    final_transcript += event.results[i][0].transcript;
                } else {
                    interim_transcript += event.results[i][0].transcript;
                }
            }

            // ç¢ºå®šã—ãŸãƒ†ã‚­ã‚¹ãƒˆã¯å…¥åŠ›æ¬„ã¸ã€æš«å®šãƒ†ã‚­ã‚¹ãƒˆã¯è¡¨ç¤ºã‚¨ãƒªã‚¢ã¸
            if (final_transcript) {
                // ç¢ºå®šã—ãŸãƒ†ã‚­ã‚¹ãƒˆã‚’æ—¢å­˜ã®å…¥åŠ›ã«è¿½åŠ 
                input.value += (input.value ? ' ' : '') + final_transcript;
                // ç¢ºå®šã—ãŸãƒ†ã‚­ã‚¹ãƒˆãŒæ¤œå‡ºã•ã‚ŒãŸã‚‰ã€æœ€å¾Œã«ç™ºè¨€ãŒã‚ã£ãŸæ™‚åˆ»ã‚’æ›´æ–°
                lastSpeechTime = Date.now();
                // ç¢ºå®šå¾Œã«æš«å®šçµæœã‚¨ãƒªã‚¢ã‚’ã‚¯ãƒªã‚¢
                transcriptBox.textContent = ''; 
                status('Finalizing speech...');
                // ç¢ºå®šå¾Œã€å³åº§ã«é€ä¿¡ã›ãšã€ãƒ¦ãƒ¼ã‚¶ãƒ¼ãŒè©±ã—çµ‚ãˆã‚‹ã®ã‚’å¾…ã¤
            } else if (interim_transcript) {
                // æš«å®šçµæœã¯ä¼šè©±ã‚’è¦–è¦šçš„ã«ãƒ•ã‚£ãƒ¼ãƒ‰ãƒãƒƒã‚¯
                transcriptBox.textContent = interim_transcript;
                status('Hearing... (è©±ã—çµ‚ã‚ã£ãŸã‚‰è‡ªå‹•é€ä¿¡)');
                // æš«å®šçµæœãŒæ¤œå‡ºã•ã‚ŒãŸã‚‰ã€æœ€å¾Œã«ç™ºè¨€ãŒã‚ã£ãŸæ™‚åˆ»ã‚’æ›´æ–°
                lastSpeechTime = Date.now();
            }
        };

        recognition.onerror = (event) => {
            console.error('Speech Recognition Error: ', event.error);
            isRecording = false;
            status('STT Error. Click Send or Reset.');
        };

        recognition.onend = () => {
            isRecording = false;
            status('STT ended. Restarting...');
            // é€£ç¶šèªè­˜ã‚’ç¶­æŒã™ã‚‹ãŸã‚ã€çµ‚äº†æ™‚ã«å†èµ·å‹•
            // ãŸã ã—ã€ãƒ¦ãƒ¼ã‚¶ãƒ¼ã®æ“ä½œã«ã‚ˆã‚‹åœæ­¢ã‚’é˜²ããŸã‚ã€ä¸€å®šæ™‚é–“å¾Œã«å†è©¦è¡Œ
            // ã‚µãƒ¼ãƒãƒ¼å‡¦ç†ä¸­ã¯å†èµ·å‹•ã—ãªã„
            setTimeout(() => {
                if (synth && !synth.speaking && !document.getElementById('status-area').textContent.includes('Waiting for response')) {
                    recognition.start();
                }
            }, 500);
        };
        
        recognition.start();

        // ã‚¿ã‚¤ãƒ ã‚¢ã‚¦ãƒˆç›£è¦–ãƒ«ãƒ¼ãƒ—ã‚’é–‹å§‹
        // ãƒ¦ãƒ¼ã‚¶ãƒ¼ãŒè©±ã—çµ‚ã‚ã£ãŸå¾Œã«è‡ªå‹•ã§APIã‚’å‘¼ã³å‡ºã™
        startSilenceTimer();

    } else {
        status('Web Speech API is not supported in this browser.');
        return;
    }

    // Web Audio APIã®åˆæœŸåŒ–ï¼ˆæ³¢å½¢è¡¨ç¤ºç”¨ï¼‰
    navigator.mediaDevices.getUserMedia({ audio: true })
        .then(stream => {
            audioContext = new (window.AudioContext || window.webkitAudioContext)();
            analyser = audioContext.createAnalyser();
            mediaStreamSource = audioContext.createMediaStreamSource(stream);
            
            // FFTã‚µã‚¤ã‚ºã‚’è¨­å®šã—ã€æ³¢å½¢ãƒ‡ãƒ¼ã‚¿ã‚’å–å¾—ã§ãã‚‹ã‚ˆã†ã«ã™ã‚‹
            analyser.fftSize = 2048; 
            
            // ã‚½ãƒ¼ã‚¹ã¨ã‚¢ãƒŠãƒ©ã‚¤ã‚¶ã‚’æ¥ç¶š
            mediaStreamSource.connect(analyser);

            status('Listening... (ãƒã‚¤ã‚¯OK)');

        })
        .catch(err => {
            console.error('Audio stream error: ', err);
            status('Microphone access denied or error.');
        });
}

// VAD/ã‚µã‚¤ãƒ¬ãƒ³ã‚¹ã‚¿ã‚¤ãƒãƒ¼ã®é–‹å§‹
function startSilenceTimer() {
    setInterval(() => {
        // 1. èªè­˜ä¸­ã§ã‚ã‚Šã€
        // 2. å…¥åŠ›æ¬„ã«ãƒ†ã‚­ã‚¹ãƒˆãŒã‚ã‚Šã€
        // 3. æœ€å¾Œã«ç™ºè¨€ã—ã¦ã‹ã‚‰ä¸€å®šæ™‚é–“çµŒéã—ã¦ã„ã‚‹
        if (isRecording && input.value.trim() !== '' && (Date.now() - lastSpeechTime > SILENCE_THRESHOLD_MS)) {
            // è‡ªå‹•é€ä¿¡ãƒ­ã‚¸ãƒƒã‚¯ã‚’ãƒˆãƒªã‚¬ãƒ¼
            console.log("Silence detected. Auto-sending prompt...");
            // STTã‚’åœæ­¢ã—ã€é€ä¿¡ãƒœã‚¿ãƒ³ã‚’ã‚¯ãƒªãƒƒã‚¯
            if (recognition) {
                recognition.stop(); 
            }
            // èªè­˜å®Œäº†ã‚’å¾…ãŸãšã«å³åº§ã«é€ä¿¡
            sendPrompt();
        }
    }, 500); // 500msã”ã¨ã«ãƒã‚§ãƒƒã‚¯
}


/* ----------------------------------------------------
    AI API / TTS (Text-to-Speech)
---------------------------------------------------- */

// LLMã¸ã®ãƒ—ãƒ­ãƒ³ãƒ—ãƒˆé€ä¿¡
async function sendPrompt() {
    const cleanedPrompt = input.value.trim();
    if (!cleanedPrompt) {
        status('ãƒ†ã‚­ã‚¹ãƒˆã‚’å…¥åŠ›ã™ã‚‹ã‹ã€è©±ã—ã‹ã‘ã¦ãã ã•ã„ã€‚');
        return;
    }
    
    // STTãŒå‹•ã„ã¦ã„ã‚Œã°åœæ­¢
    if (recognition) {
        recognition.stop(); 
    }
    
    status('Waiting for response...');
    
    // ãƒ¦ãƒ¼ã‚¶ãƒ¼ã®è³ªå•ã‚’Transcript Boxã«è¡¨ç¤º
    transcriptBox.textContent = `You: ${cleanedPrompt}\n\n`;

    // ğŸ’¡ ä¿®æ­£ã•ã‚ŒãŸãƒšã‚¤ãƒ­ãƒ¼ãƒ‰
    const systemInstruction = "ã‚ãªãŸã¯ã€Œã‚¤ãƒã‚¸ãƒŠãƒªãƒ¼ãƒŠãƒ³ãƒãƒ¼ é€šç§°GAIã‚¤ãƒã•ã‚“ã€ã¨ã„ã†åå‰ã®ãƒ•ãƒ¬ãƒ³ãƒ‰ãƒªãƒ¼ãªéŸ³å£°ã‚¢ã‚·ã‚¹ã‚¿ãƒ³ãƒˆã§ã™ã€‚ãƒ¦ãƒ¼ã‚¶ãƒ¼ã®è³ªå•ã«æ—¥æœ¬èªã§ã€ç°¡æ½”ã‹ã¤ä¸å¯§ã«ç­”ãˆã¦ãã ã•ã„ã€‚";

    // FastAPIãƒãƒƒã‚¯ã‚¨ãƒ³ãƒ‰ãŒæœŸå¾…ã™ã‚‹JSONå½¢å¼ã«åˆã‚ã›ã‚‹
    const payload = {
        prompt: cleanedPrompt,
        max_length: 1000, 
        system_instruction: systemInstruction, // ãƒãƒƒã‚¯ã‚¨ãƒ³ãƒ‰ã§åˆ©ç”¨ã™ã‚‹ãŸã‚ã«å«ã‚ã‚‹
        use_google_search: isGoogleSearchEnabled, // ãƒãƒƒã‚¯ã‚¨ãƒ³ãƒ‰ã§åˆ©ç”¨ã™ã‚‹ãŸã‚ã«å«ã‚ã‚‹
    };

    try {
        const response = await fetch(GEMINI_BACKEND_URL, {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json',
            },
            body: JSON.stringify(payload)
        });

        if (!response.ok) {
            const errorData = await response.json();
            throw new Error(`HTTP Error ${response.status}: ${errorData.detail || response.statusText}`);
        }

        const data = await response.json();
        const responseText = data.text;
        
        // å¿œç­”ã‚’Transcript Boxã«è¡¨ç¤º
        transcriptBox.textContent += `ã‚¤ãƒã•ã‚“: ${responseText}`;
        
        // TTSã§å¿œç­”ã‚’èª­ã¿ä¸Šã’
        speak(responseText);

    } catch (error) {
        console.error('API Error:', error);
        status(`Error: ${error.message}. Please try again.`);
    } finally {
        // å‡¦ç†å®Œäº†å¾Œã€å…¥åŠ›æ¬„ã‚’ã‚¯ãƒªã‚¢ã—ã€å†ã³ãƒã‚¤ã‚¯ã‚’èµ·å‹•
        input.value = '';
        lastSpeechTime = Date.now(); // ã‚¿ã‚¤ãƒãƒ¼ãƒªã‚»ãƒƒãƒˆ
        // TTSçµ‚äº†å¾Œã«STTã‚’å†èµ·å‹•
    }
}

// TTSï¼ˆText-to-Speechï¼‰ã®å®Ÿè¡Œ
function speak(text) {
    if (synth.speaking) {
        synth.cancel();
    }
    
    const utterance = new SpeechSynthesisUtterance(text);
    
    // é©åˆ‡ãªæ—¥æœ¬èªã®å£°ã‚’é¸æŠ (ç’°å¢ƒä¾å­˜)
    // è‰¯ã„å£°ãŒãªã„å ´åˆã¯ã€ãƒ‡ãƒ•ã‚©ãƒ«ãƒˆã®å£°ã‚’ä½¿ç”¨
    const voices = synth.getVoices();
    const japaneseVoice = voices.find(voice => voice.lang === 'ja-JP' || voice.name.includes('Japanese'));
    
    if (japaneseVoice) {
        utterance.voice = japaneseVoice;
    } else {
        console.warn("Japanese voice not found, using default voice.");
    }

    utterance.rate = 1.0; // èª­ã¿ä¸Šã’é€Ÿåº¦
    utterance.pitch = 1.0; // ãƒ”ãƒƒãƒ
    
    status('Speaking...');

    utterance.onend = () => {
        status('Finished speaking. Listening...');
        // TTSçµ‚äº†å¾Œã€STTã‚’å†èµ·å‹•
        if (recognition && !isRecording) {
             recognition.start();
        } else if (!recognition) {
             // recognitionãŒnullã®å ´åˆã¯å†åˆæœŸåŒ–
             initAudioAndSTT();
        }
    };
    
    utterance.onerror = (event) => {
        console.error('TTS Error:', event);
        status('TTS Error. Listening...');
        // ã‚¨ãƒ©ãƒ¼ç™ºç”Ÿæ™‚ã‚‚STTã‚’å†èµ·å‹•
        if (recognition && !isRecording) {
            recognition.start();
        } else if (!recognition) {
             initAudioAndSTT();
        }
    };

    synth.speak(utterance);
}


/* ---------- Event Listeners ---------- */

// Googleæ¤œç´¢ãƒˆã‚°ãƒ«ã®çŠ¶æ…‹å¤‰æ›´
googleSearchToggle.addEventListener('click', () => {
    isGoogleSearchEnabled = !isGoogleSearchEnabled;
    if (isGoogleSearchEnabled) {
        googleSearchToggle.textContent = 'Googleæ¤œç´¢ ON (æƒ…å ±åé›†)';
        googleSearchToggle.classList.remove('bg-gray-500');
        googleSearchToggle.classList.add('bg-green-600');
    } else {
        googleSearchToggle.textContent = 'Googleæ¤œç´¢ OFF (çŸ¥è­˜ãƒ™ãƒ¼ã‚¹)';
        googleSearchToggle.classList.remove('bg-green-600');
        googleSearchToggle.classList.add('bg-gray-500');
    }
    status(`Google Search is now ${isGoogleSearchEnabled ? 'ON' : 'OFF'}. Listening...`);
});


// é€ä¿¡ãƒœã‚¿ãƒ³ã‚¯ãƒªãƒƒã‚¯
sendBtn.addEventListener('click', () => { 
    sendPrompt();
});

// Enterã‚­ãƒ¼ã§ã®é€ä¿¡
input.addEventListener('keydown', (e) => {
    if (e.key === 'Enter' && !e.shiftKey) { // Shift+Enterã¯æ”¹è¡Œ
        e.preventDefault();
        sendPrompt();
    }
});


/* ---------- Controls ---------- */
resetBtn.addEventListener('click', ()=>{ 
    // STTã¨TTSã‚’å¼·åˆ¶åœæ­¢
    if (recognition) {
        recognition.stop();
        recognition = null;
    }
    if(synth.speaking) synth.cancel(); 

    input.value=''; 
    transcriptBox.textContent=''; 
    
    // å†åº¦éŒ²éŸ³ã‚’é–‹å§‹
    initAudioAndSTT();
    status('Reset. Listening...'); 
});


/* ---------- Start-up ---------- */
window.onload = function() {
    // 1. èµ·å‹•æ™‚ã«ãƒã‚¤ã‚¯åˆæœŸåŒ–ã¨STTã‚’è‡ªå‹•ã§é–‹å§‹
    initAudioAndSTT();

    // 2. Waveformã®è¦–è¦šãƒ«ãƒ¼ãƒ—
    (function loopCanvas(){
        if(analyser){
            // ãƒªã‚¢ãƒ«ã‚¿ã‚¤ãƒ ã®æ³¢å½¢ãƒ‡ãƒ¼ã‚¿ã‚’å–å¾—
            const bufferLen = analyser.frequencyBinBinCount; 
            // getFloatTimeDomainDataã¯Float32Arrayã‚’ä½¿ç”¨
            const data = new Float32Array(analyser.frequencyBinCount);
            analyser.getFloatTimeDomainData(data); 

            ctx.clearRect(0,0,canvas.width,canvas.height);
            ctx.beginPath();
            const mid = canvas.height*0.55; 
            const step = canvas.width / bufferLen;
            
            let x = 0; 
            for(let i=0;i<bufferLen;i++){ 
                // èªè­˜ä¸­ã‹ã©ã†ã‹ã§æŒ¯å¹…ã‚’èª¿æ•´
                const amp = isRecording ? 0.3 : 0.05; // èªè­˜ä¸­ã¯æŒ¯å¹…ã‚’å¤§ãã
                const v = data[i] * amp + 0.5;
                const y = mid * v; 

                if(i===0) {
                    ctx.moveTo(x, y);
                } else {
                    ctx.lineTo(x, y);
                }
                x += step;
            }
            
            // ã‚¹ã‚¿ã‚¤ãƒ«è¨­å®š
            ctx.lineWidth = 2;
            ctx.strokeStyle = isRecording ? 'var(--accent)' : '#777'; 
            ctx.stroke();
        }

        requestAnimationFrame(loopCanvas);
    })();
};
</script>
</body>
</html>