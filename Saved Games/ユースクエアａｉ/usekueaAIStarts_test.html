<!DOCTYPE html>
<html lang="ja">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Gemini AI Assistant UI (ãƒ†ã‚¹ãƒˆ)</title>
    <!-- Tailwind CSSã®èª­ã¿è¾¼ã¿ -->
    <script src="https://cdn.tailwindcss.com"></script>
    <style>
        /* ã‚«ã‚¹ã‚¿ãƒ ã‚¹ã‚¿ã‚¤ãƒ«: ã‚¤ãƒ³ã‚¿ãƒ¼ãƒ•ã‚©ãƒ³ãƒˆã‚’é©ç”¨ */
        body {
            font-family: 'Inter', sans-serif;
            background-color: #f7f9fc;
        }
        /* ã‚¹ãƒ”ãƒŠãƒ¼ã®ãŸã‚ã®CSS */
        .spinner {
            border: 4px solid rgba(255, 255, 255, 0.3);
            border-top: 4px solid #10b981; /* ã‚¨ãƒ¡ãƒ©ãƒ«ãƒ‰ã‚°ãƒªãƒ¼ãƒ³ */
            border-radius: 50%;
            width: 24px;
            height: 24px;
            animation: spin 1s linear infinite;
        }
        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }
    </style>
</head>
<body class="p-4 md:p-8 min-h-screen flex items-start justify-center">

    <div class="w-full max-w-2xl bg-white p-6 md:p-8 rounded-xl shadow-2xl border border-gray-100">
        <h1 class="text-3xl font-bold text-gray-800 mb-2 flex items-center">
            <svg class="w-8 h-8 mr-2 text-emerald-500" fill="none" stroke="currentColor" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9.663 17h4.673M12 3v1m6.364 1.636l-.707.707M16 12h1m-1.636 4.364l.707.707M4 12H3m1.636 4.364L3.929 17.707M19.791 7.379l-1.414 1.414M4.929 7.379l1.414 1.414M12 18h.01"></path></svg>
            AIã‚¢ã‚·ã‚¹ã‚¿ãƒ³ãƒˆãƒ»ãƒ†ã‚¹ã‚¿ãƒ¼
        </h1>
        <p class="text-gray-500 mb-6">ãƒãƒƒã‚¯ã‚¨ãƒ³ãƒ‰ã®FastAPIã‚µãƒ¼ãƒãƒ¼ã«æ¥ç¶šã—ã€Geminiãƒ¢ãƒ‡ãƒ«ã‹ã‚‰ã®å¿œç­”ã‚’ç¢ºèªã—ã¾ã™ã€‚</p>

        <!-- å…¥åŠ›ã‚¨ãƒªã‚¢ -->
        <div class="mb-6">
            <label for="prompt" class="block text-sm font-medium text-gray-700 mb-2">ãƒ—ãƒ­ãƒ³ãƒ—ãƒˆã‚’å…¥åŠ›ã—ã¦ãã ã•ã„:</label>
            <textarea id="prompt" rows="4" class="w-full p-3 border border-gray-300 rounded-lg focus:ring-emerald-500 focus:border-emerald-500 transition duration-150 shadow-sm" placeholder="ä¾‹: äººå·¥çŸ¥èƒ½ãƒ¦ãƒ¼ã‚¹ã‚¯ã‚¨ã‚¢AI - éŸ³å£°ã‚¢ã‚·ã‚¹ã‚¿ãƒ³ãƒˆã¨ã—ã¦è‡ªå·±ç´¹ä»‹ã—ã¦ãã ã•ã„ã€‚" required></textarea>
        </div>

        <!-- å¿œç­”ãƒˆãƒ¼ã‚¯ãƒ³è¨­å®š -->
        <div class="mb-6 flex items-center space-x-4">
            <label for="max_length" class="text-sm font-medium text-gray-700">æœ€å¤§å¿œç­”ãƒˆãƒ¼ã‚¯ãƒ³:</label>
            <input type="number" id="max_length" value="1000" min="100" max="4096" class="p-2 border border-gray-300 rounded-lg w-24 text-center shadow-sm">
        </div>

        <!-- é€ä¿¡ãƒœã‚¿ãƒ³ -->
        <button id="submitButton" class="w-full py-3 px-4 bg-emerald-600 text-white font-semibold rounded-lg hover:bg-emerald-700 transition duration-200 focus:outline-none focus:ring-4 focus:ring-emerald-500 focus:ring-opacity-50 flex items-center justify-center shadow-md" onclick="generateResponse()">
            <span id="buttonText">AIå¿œç­”ã‚’ç”Ÿæˆ</span>
            <div id="loadingSpinner" class="spinner ml-3 hidden"></div>
        </button>

        <!-- å¿œç­”è¡¨ç¤ºã‚¨ãƒªã‚¢ -->
        <div class="mt-8">
            <h2 class="text-xl font-semibold text-gray-800 mb-3 border-b pb-1">AIå¿œç­”</h2>
            <div id="responseContainer" class="p-4 bg-gray-50 border border-gray-200 rounded-lg min-h-[100px] whitespace-pre-wrap shadow-inner text-gray-700 leading-relaxed">
                ã“ã“ã«AIã‹ã‚‰ã®å¿œç­”ãŒè¡¨ç¤ºã•ã‚Œã¾ã™ã€‚
            </div>
            <p id="statusMessage" class="mt-4 text-sm text-center font-medium"></p>
        </div>
    </div>

    <script>
        // ãƒãƒƒã‚¯ã‚¨ãƒ³ãƒ‰ã®URLã€‚Canvasç’°å¢ƒã§ã¯ã€ãƒ«ãƒ¼ãƒˆï¼ˆ/ï¼‰ãŒFastAPIã‚µãƒ¼ãƒãƒ¼ã«ãƒãƒƒãƒ”ãƒ³ã‚°ã•ã‚Œã¾ã™ã€‚
        const API_URL = "/llm/generate";
        
        const button = document.getElementById('submitButton');
        const buttonText = document.getElementById('buttonText');
        const spinner = document.getElementById('loadingSpinner');
        const responseContainer = document.getElementById('responseContainer');
        const statusMessage = document.getElementById('statusMessage');

        /**
         * Exponential backoffã‚’ä½¿ç”¨ã—ãŸãƒ•ã‚§ãƒƒãƒé–¢æ•°
         * @param {string} url - API URL
         * @param {object} options - fetchã‚ªãƒ—ã‚·ãƒ§ãƒ³
         * @param {number} retries - æœ€å¤§ãƒªãƒˆãƒ©ã‚¤å›æ•°
         * @returns {Promise<Response>} fetchå¿œç­”
         */
        async function fetchWithBackoff(url, options, retries = 5) {
            for (let i = 0; i < retries; i++) {
                try {
                    const response = await fetch(url, options);
                    if (response.status !== 503 && response.status !== 429) {
                        return response; // æˆåŠŸã¾ãŸã¯æ°¸ç¶šçš„ãªã‚¨ãƒ©ãƒ¼
                    }
                    // 503/429ã‚¨ãƒ©ãƒ¼ã®å ´åˆã€ãƒªãƒˆãƒ©ã‚¤
                    throw new Error(`Transient error: ${response.status}`);
                } catch (error) {
                    if (i === retries - 1) {
                        throw error; // æœ€çµ‚ãƒªãƒˆãƒ©ã‚¤ã§å¤±æ•—
                    }
                    // Exponential backoff
                    const delay = Math.pow(2, i) * 1000 + Math.random() * 1000;
                    await new Promise(resolve => setTimeout(resolve, delay));
                }
            }
        }


        async function generateResponse() {
            const prompt = document.getElementById('prompt').value.trim();
            const maxLength = parseInt(document.getElementById('max_length').value, 10);

            if (!prompt) {
                statusMessage.textContent = "ğŸ”´ ã‚¨ãƒ©ãƒ¼: ãƒ—ãƒ­ãƒ³ãƒ—ãƒˆã‚’å…¥åŠ›ã—ã¦ãã ã•ã„ã€‚";
                statusMessage.className = 'mt-4 text-sm text-center font-medium text-red-600';
                return;
            }

            // UIçŠ¶æ…‹ã‚’ãƒ­ãƒ¼ãƒ‰ä¸­ã«è¨­å®š
            button.disabled = true;
            buttonText.textContent = "ç”Ÿæˆä¸­...";
            spinner.classList.remove('hidden');
            responseContainer.textContent = "AIå¿œç­”ã‚’å¾…æ©Ÿã—ã¦ã„ã¾ã™...";
            statusMessage.textContent = "";
            statusMessage.className = 'mt-4 text-sm text-center font-medium';


            try {
                const payload = {
                    prompt: prompt,
                    max_length: maxLength
                };

                const response = await fetchWithBackoff(API_URL, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify(payload)
                });

                const data = await response.json();

                if (response.ok) {
                    // æˆåŠŸå¿œç­”
                    responseContainer.textContent = data.text;
                    statusMessage.textContent = "âœ… å¿œç­”ãŒæ­£å¸¸ã«ç”Ÿæˆã•ã‚Œã¾ã—ãŸï¼";
                    statusMessage.className = 'mt-4 text-sm text-center font-medium text-emerald-600';
                } else {
                    // APIã‹ã‚‰ã®ã‚¨ãƒ©ãƒ¼å¿œç­” (ä¾‹: 500, APIã‚­ãƒ¼ä¸è¶³)
                    const errorDetail = data.detail || "è©³ç´°ä¸æ˜ã®ã‚¨ãƒ©ãƒ¼ã§ã™ã€‚ã‚µãƒ¼ãƒãƒ¼ãƒ­ã‚°ã‚’ç¢ºèªã—ã¦ãã ã•ã„ã€‚";
                    responseContainer.textContent = `ã‚¨ãƒ©ãƒ¼ãŒç™ºç”Ÿã—ã¾ã—ãŸã€‚\nè©³ç´°: ${errorDetail}`;
                    statusMessage.textContent = "ğŸ”´ ã‚µãƒ¼ãƒãƒ¼ã‚¨ãƒ©ãƒ¼: AIå¿œç­”ã®ç”Ÿæˆã«å¤±æ•—ã—ã¾ã—ãŸã€‚";
                    statusMessage.className = 'mt-4 text-sm text-center font-medium text-red-600';
                }

            } catch (error) {
                // ãƒãƒƒãƒˆãƒ¯ãƒ¼ã‚¯ã‚¨ãƒ©ãƒ¼ã‚„ãƒ•ã‚§ãƒƒãƒã®ã‚¨ãƒ©ãƒ¼
                responseContainer.textContent = `æ¥ç¶šã‚¨ãƒ©ãƒ¼ãŒç™ºç”Ÿã—ã¾ã—ãŸã€‚ãƒãƒƒã‚¯ã‚¨ãƒ³ãƒ‰ãŒå®Ÿè¡Œä¸­ã‹ã€CORSè¨­å®šãŒæ­£ã—ã„ã‹ç¢ºèªã—ã¦ãã ã•ã„ã€‚`;
                statusMessage.textContent = "âŒ ãƒãƒƒãƒˆãƒ¯ãƒ¼ã‚¯ã¾ãŸã¯å†…éƒ¨ã‚¨ãƒ©ãƒ¼ã€‚";
                statusMessage.className = 'mt-4 text-sm text-center font-medium text-red-600';
            } finally {
                // UIçŠ¶æ…‹ã‚’ãƒªã‚»ãƒƒãƒˆ
                button.disabled = false;
                buttonText.textContent = "AIå¿œç­”ã‚’ç”Ÿæˆ";
                spinner.classList.add('hidden');
            }
        }

        // åˆæœŸãƒ˜ãƒ«ã‚¹ãƒã‚§ãƒƒã‚¯ï¼ˆã‚ªãƒ—ã‚·ãƒ§ãƒ³ï¼‰
        window.onload = async () => {
            try {
                const response = await fetch('/');
                const data = await response.json();
                if (data.status === 'ok') {
                    const clientStatus = data.client_status === 'Ready' ? 'æ¥ç¶šæº–å‚™å®Œäº†' : 'APIã‚­ãƒ¼ã‚¨ãƒ©ãƒ¼';
                    statusMessage.textContent = `ã‚µãƒ¼ãƒãƒ¼çŠ¶æ…‹: OK (${clientStatus})`;
                    statusMessage.className = 'mt-4 text-sm text-center font-medium ' + (data.client_status === 'Ready' ? 'text-emerald-600' : 'text-orange-500');
                } else {
                    statusMessage.textContent = `ã‚µãƒ¼ãƒãƒ¼çŠ¶æ…‹: èµ·å‹•ä¸­ã§ã™ãŒã€ãƒ«ãƒ¼ãƒˆã‚¨ãƒ³ãƒ‰ãƒã‚¤ãƒ³ãƒˆãŒç•°å¸¸ã§ã™ã€‚`;
                    statusMessage.className = 'mt-4 text-sm text-center font-medium text-orange-500';
                }
            } catch (e) {
                statusMessage.textContent = `ã‚µãƒ¼ãƒãƒ¼çŠ¶æ…‹: æ¥ç¶šã§ãã¾ã›ã‚“ã€‚ãƒ‡ãƒ—ãƒ­ã‚¤ã‚’ç¢ºèªã—ã¦ãã ã•ã„ã€‚`;
                statusMessage.className = 'mt-4 text-sm text-center font-medium text-red-600';
            }
        }
    </script>
</body>
</html>
